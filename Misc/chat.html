<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat Room</title>
<style>
  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:Arial,Helvetica,sans-serif;
    background:#121212;
    color:#fff;
  }
  .container{
    width:92%;
    max-width:980px;
    background:#1f1f1f;
    border-radius:12px;
    padding:18px;
    box-sizing:border-box;
    border:1px solid #333;
  }
  #chatBox{
    height:420px;
    overflow:auto;
    background:#222;
    border-radius:8px;
    padding:12px;
    border:1px solid #333;
  }
  #inputArea{ display:flex; gap:10px; margin-top:12px; align-items:center; }
  input[type="text"], input[type="email"], input[type="password"]{
    padding:10px; border-radius:6px; border:1px solid #333; background:#111; color:#fff; outline:none; flex:1;
  }
  input[type="file"]{ padding:6px; }
  button{ padding:10px 12px; border-radius:6px; border:none; cursor:pointer; background:#0078ff; color:white; }
  .muted{ color:rgba(255,255,255,0.7); font-size:0.95rem; }
  .delete-btn{ color:#ff6666; margin-left:10px; cursor:pointer; font-size:0.85rem; }
  .chat-img{ display:block; max-width:220px; max-height:220px; margin-top:6px; border-radius:6px; cursor:pointer; }
  .chat-video{ display:block; max-width:320px; max-height:240px; margin-top:6px; border-radius:6px; cursor:pointer; }

  /* Admin controls */
  #adminControlPanel{ display:none; margin-top:12px; background:#2a2a2a; padding:12px; border-radius:8px; border:1px solid #3a3a3a; }
  #userList{ margin-top:8px; max-height:260px; overflow:auto; }
  #dbManager{ display:none; margin-top:10px; background:#222; padding:8px; border-radius:8px; border:1px solid #333; }

  /* simple message block spacing */
  .message { margin-bottom:10px; line-height:1.3; padding:6px; border-radius:6px; }

  @media (max-width:720px){
    #chatBox{ height:300px; }
    .container{ padding:12px; }
  }
</style>
</head>
<body>
<div class="container">

  <div id="authContainer">
    <h2 style="margin:0 0 10px 0;">Sign In or Register</h2>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <input id="inviteCode" type="text" placeholder="Invite Code (for registration)" />
      <div style="display:flex;gap:8px;">
        <button id="loginBtn">Login</button>
        <button id="registerBtn" style="background:#00aa88">Register</button>
      </div>
      <p id="authError" style="color:#ff6666;margin:0;"></p>
    </div>
  </div>

  <div id="chatContainer" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h2 style="margin:0">Chat Room</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <button id="generateInviteBtn" style="background:#00cc66">Generate Invite</button>
        <button id="viewCodesBtn" style="background:#ffaa00">View Invite Codes</button>
        <div id="myCodes" style="display:none;color:rgba(255,255,255,0.7);"></div>
      </div>
    </div>

    <div id="chatBox" aria-live="polite"></div>

    <div id="inputArea">
      <input id="messageInput" type="text" placeholder="Type a message..." />
      <input id="fileInput" type="file" accept="image/*,video/*" />
      <button id="sendButton">Send</button>
      <button id="logoutBtn" style="background:#ff4444">Logout</button>
    </div>

    <!-- Admin controls -->
    <div id="adminControlPanel">
      <strong>ðŸ›  Admin Controls</strong>
      <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;">
        <button id="broadcastBtn" style="background:#ffaa00;">Broadcast Message</button>
        <button id="viewUsersBtn" style="background:#0078ff;">Manage Users</button>
        <button id="dbManagerBtn" style="background:#aa66ff;">Manage Database</button>
        <button id="themeBtn" style="background:#00cc88;">Change Chat Theme</button>
        <button id="purgeBtn" style="background:#ff6666;">Purge All Messages</button>
      </div>
      <div id="userList" style="display:none; margin-top:12px;"></div>
      <div id="dbManager" style="display:none; margin-top:12px;"></div>
    </div>

</div>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { getDatabase, ref, push, onChildAdded, onChildRemoved, remove, query, orderByChild, off, set, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCN8ypq4TxhLwjseqnDJneBO2j_BlARz0M",
  authDomain: "chat-or-somethig.firebaseapp.com",
  databaseURL: "https://chat-or-somethig-default-rtdb.firebaseio.com",
  projectId: "chat-or-somethig",
  storageBucket: "chat-or-somethig.appspot.com",
  messagingSenderId: "598777875087",
  appId: "1:598777875087:web:d100536dd269bc0a9d7efa"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const authContainer = document.getElementById("authContainer");
const chatContainer = document.getElementById("chatContainer");
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendButton");
const logoutBtn = document.getElementById("logoutBtn");
const generateBtn = document.getElementById("generateInviteBtn");
const viewBtn = document.getElementById("viewCodesBtn");
const myCodesDiv = document.getElementById("myCodes");
const fileInput = document.getElementById("fileInput");
const adminPanel = document.getElementById("adminControlPanel");

const ADMIN_EMAILS = [
  "aj.xanman@gmail.com",
  "alexa_pears736@ahschools.us",
  "uyiog_aghay195@ahschools.us",
  "carso_keller363@ahschools.us",
  "legyo_dereg506@ahschools.us",
  "jacks_waara234@ahschools.us",
  "unclesam@gmail.com",
  "o71613869@gmail.com"
];

let messagesRef = null;
let currentNickname = "Anonymous";

function showError(msg){ document.getElementById("authError").innerText = msg || ""; }
function clearMessages(){ chatBox.innerHTML = ""; if(messagesRef) off(messagesRef); }

// Auth
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("password").value;
  try{
    const cred = await signInWithEmailAndPassword(auth,email,pass);
    const userRef = ref(db,"users/"+cred.user.uid);
    const snap = await get(userRef);
    if(snap.exists() && snap.val().banned){
      await signOut(auth);
      return showError("You are banned from this chat.");
    }
    showError("");
  }catch(err){ showError(err.message); }
};

document.getElementById("registerBtn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("password").value;
  const code = document.getElementById("inviteCode").value.trim();
  if(!code) return showError("Invite code required.");
  try{
    const codeRef = ref(db,"inviteCodes/"+code);
    const snap = await get(codeRef);
    if(!snap.exists()) return showError("Invalid invite code.");
    if(snap.val().used) return showError("Invite code already used.");
    const bannedSnap = await get(ref(db,"banned"));
    if(bannedSnap.exists()){
      const bannedObj = bannedSnap.val();
      if(Object.values(bannedObj).some(b => b.email === email)) return showError("This email is banned.");
    }
    await set(codeRef,{...snap.val(), used:true});
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    const nick = prompt("Choose a nickname:") || "Anonymous";
    await set(ref(db,"users/"+cred.user.uid), { nickname: nick, email: email });
    showError("");
  }catch(err){ showError(err.message); }
};

// Auth state
onAuthStateChanged(auth, async user => {
  if(user){
    authContainer.style.display = "none";
    chatContainer.style.display = "block";
    const snap = await get(ref(db,"users/"+user.uid));
    if(snap.exists()) currentNickname = snap.val().nickname || "Anonymous";
    if(user && ADMIN_EMAILS.includes(user.email)) adminPanel.style.display="block";
    else adminPanel.style.display="none";
    loadMessages();
  } else {
    authContainer.style.display = "block";
    chatContainer.style.display = "none";
    clearMessages();
  }
});

// Send messages
async function sendMessage(text="", imageUrl=""){
  if(!text && !imageUrl) return;
  const user = auth.currentUser;
  if(!user) return alert("Sign in.");
  await push(ref(db,"messages"), {
    uid: user.uid,
    email: user.email,
    nickname: currentNickname,
    text: text,
    imageUrl: imageUrl || "",
    timestamp: Date.now()
  });
  msgInput.value = "";
}

sendBtn.onclick = ()=> sendMessage(msgInput.value);
msgInput.addEventListener("keypress", e => { if(e.key==="Enter") sendMessage(msgInput.value); });

// Load messages
function loadMessages(){
  if(messagesRef) off(messagesRef);
  chatBox.innerHTML = "";
  messagesRef = query(ref(db,"messages"), orderByChild("timestamp"));
  onChildAdded(messagesRef, snap=>{
    const msg = snap.val();
    const wrapper = document.createElement("div");
    wrapper.className="message";
    wrapper.id="msg-"+snap.key;

    const d = new Date(msg.timestamp || Date.now());
    const timeStr = `${((d.getHours()+11)%12)+1}:${d.getMinutes().toString().padStart(2,"0")} ${d.getHours()>=12?"PM":"AM"}`;

    let nameHtml = `<strong style="color:#fff">${msg.nickname || "Anonymous"}</strong>`;
    wrapper.innerHTML = `<div>${nameHtml} <span class="muted">(${timeStr}):</span></div>`+
                        (msg.text? `<div style="margin-top:4px;">${msg.text}</div>`:"")+
                        (msg.imageUrl? `<div>${/(\.mp4|\.webm)/i.test(msg.imageUrl)?`<video class="chat-video" src="${msg.imageUrl}" controls></video>`:`<img class="chat-img" src="${msg.imageUrl}">`}</div>`:"");

    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
  });

  onChildRemoved(ref(db,"messages"), snap => {
    const el = document.getElementById("msg-"+snap.key);
    if(el) el.remove();
  });
}

logoutBtn.onclick = () => signOut(auth);

</script>
</body>
</html>
