<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat Room)</title>
<style>
  :root {
    --bg: #121212;
    --card: #1f1f1f;
    --muted: rgba(255,255,255,0.7);
    --accent: #0078ff;
  }
  body{
    margin:0;
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    font-family:Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:#fff;
  }
  .container{
    width:92%;
    max-width:980px;
    background:var(--card);
    border-radius:12px;
    padding:18px;
    box-sizing:border-box;
    border:1px solid #333;
  }
  #chatBox{
    height:420px;
    overflow:auto;
    background:#222;
    border-radius:8px;
    padding:12px;
    border:1px solid #333;
  }
  #inputArea{ display:flex; gap:10px; margin-top:12px; align-items:center; }
  input[type="text"], input[type="email"], input[type="password"]{
    padding:10px; border-radius:6px; border:1px solid #333; background:#111; color:#fff; outline:none; flex:1;
  }
  input[type="file"]{ padding:6px; }
  button{ padding:10px 12px; border-radius:6px; border:none; cursor:pointer; background:var(--accent); color:white; }
  .muted{ color:var(--muted); font-size:0.95rem; }
  .delete-btn{ color:#ff6666; margin-left:10px; cursor:pointer; font-size:0.85rem; }
  .chat-img{ display:block; max-width:220px; max-height:220px; margin-top:6px; border-radius:6px; cursor:pointer; }
  .chat-video{ display:block; max-width:320px; max-height:240px; margin-top:6px; border-radius:6px; cursor:pointer; }
  #imgModal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); align-items:center; justify-content:center; z-index:2000; }
  #imgModal img, #imgModal video{ max-width:94%; max-height:94%; border-radius:6px; }

  /* Admin controls */
  #adminControlPanel{ display:none; margin-top:12px; background:#2a2a2a; padding:12px; border-radius:8px; border:1px solid #3a3a3a; }
  #userList{ margin-top:8px; max-height:260px; overflow:auto; }

  /* db manager */
  #dbManager{ display:none; margin-top:10px; background:#222; padding:8px; border-radius:8px; border:1px solid #333; }

  /* simple message block spacing */
  .message { margin-bottom:10px; line-height:1.3; padding:6px; border-radius:6px; }

  /* responsive */
  @media (max-width:720px){
    #chatBox{ height:300px; }
    .container{ padding:12px; }
  }
</style>
</head>
<body>
  <div class="container" id="mainContainer">

    <div id="authContainer">
      <h2 style="margin:0 0 10px 0;">Sign In or Register</h2>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <input id="email" type="email" placeholder="Email" />
        <input id="password" type="password" placeholder="Password" />
        <input id="inviteCode" type="text" placeholder="Invite Code (for registration)" />
        <div style="display:flex;gap:8px;">
          <button id="loginBtn">Login</button>
          <button id="registerBtn" style="background:#00aa88">Register</button>
        </div>
        <p id="authError" style="color:#ff6666;margin:0;"></p>
      </div>
    </div>

    <div id="chatContainer" style="display:none;">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h2 style="margin:0">Chat Room</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="generateInviteBtn" style="background:#00cc66">Generate Invite</button>
          <button id="viewCodesBtn" style="background:#ffaa00">View Invite Codes</button>
          <div id="myCodes" class="muted" style="display:none;"></div>
        </div>
      </div>

      <div id="chatBox" aria-live="polite"></div>

      <div id="inputArea">
        <input id="messageInput" type="text" placeholder="Type a message..." />
        <input id="fileInput" type="file" accept="image/*,video/*" />
        <button id="sendButton">Send</button>
        <button id="logoutBtn" style="background:#ff4444">Logout</button>
      </div>

      <!-- Extended Admin Controls -->
      <div id="adminControlPanel">
        <strong>üõ† Admin Controls</strong>
        <div style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px;">
          <button id="broadcastBtn" style="background:#ffaa00;">Broadcast Message</button>
          <button id="viewUsersBtn" style="background:#0078ff;">Manage Users</button>
          <button id="dbManagerBtn" style="background:#aa66ff;">Manage Database</button>
          <button id="themeBtn" style="background:#00cc88;">Change Chat Theme</button>
          <button id="purgeBtn" style="background:#ff6666;">Purge All Messages</button>
        </div>

        <div id="userList" style="display:none; margin-top:12px;"></div>

        <div id="dbManager" style="display:none; margin-top:12px;">
          <strong>Realtime DB Manager</strong>
          <div class="muted">View top-level nodes and delete nodes. Dangerous: use with care.</div>
          <div id="dbNodes" style="margin-top:8px;"></div>
        </div>
      </div>

    </div>

    <div id="imgModal" aria-hidden="true">
      <img id="modalImg" alt="Expanded"/>
      <video id="modalVideo" controls style="display:none;"></video>
    </div>

  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, signOut
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import {
  getDatabase, ref, push, onChildAdded, onChildRemoved, remove,
  query, orderByChild, off, set, get, update, onValue
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCN8ypq4TxhLwjseqnDJneBO2j_BlARz0M",
  authDomain: "chat-or-somethig.firebaseapp.com",
  databaseURL: "https://chat-or-somethig-default-rtdb.firebaseio.com",
  projectId: "chat-or-somethig",
  storageBucket: "chat-or-somethig.appspot.com",
  messagingSenderId: "598777875087",
  appId: "1:598777875087:web:d100536dd269bc0a9d7efa",
  measurementId: "G-VQQ0TYRNNH"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const authContainer = document.getElementById("authContainer");
const chatContainer = document.getElementById("chatContainer");
const chatBox = document.getElementById("chatBox");
const msgInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendButton");
const logoutBtn = document.getElementById("logoutBtn");
const generateBtn = document.getElementById("generateInviteBtn");
const viewBtn = document.getElementById("viewCodesBtn");
const myCodesDiv = document.getElementById("myCodes");
const fileInput = document.getElementById("fileInput");
const imgModal = document.getElementById("imgModal");
const modalImg = document.getElementById("modalImg");
const modalVideo = document.getElementById("modalVideo");

const adminPanel = document.getElementById("adminControlPanel");

const ADMIN_EMAILS = [
  "aj.xanman@gmail.com",
  "alexa_pears736@ahschools.us",
  "uyiog_aghay195@ahschools.us",
  "carso_keller363@ahschools.us",
  "legyo_dereg506@ahschools.us",
  "jacks_waara234@ahschools.us",
  "unclesam@gmail.com",
  "o71613869@gmail.com"
];

let messagesRef = null;
let currentNickname = "Anonymous";

function showError(msg){ document.getElementById("authError").innerText = msg || ""; }
function clearMessages(){ chatBox.innerHTML = ""; if(messagesRef) off(messagesRef); }

document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("password").value;
  try{
    const cred = await signInWithEmailAndPassword(auth,email,pass);
    const userRef = ref(db,"users/"+cred.user.uid);
    const snap = await get(userRef);
    if(snap.exists() && snap.val().banned){
      await signOut(auth);
      return showError("You are banned from this chat.");
    }
    showError("");
  }catch(err){ showError(err.message); }
};

document.getElementById("registerBtn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("password").value;
  const code = document.getElementById("inviteCode").value.trim();
  if(!code) return showError("Invite code required.");
  try{
    const codeRef = ref(db,"inviteCodes/"+code);
    const snap = await get(codeRef);
    if(!snap.exists()) return showError("Invalid invite code.");
    if(snap.val().used) return showError("Invite code already used.");
    const bannedSnap = await get(ref(db,"banned"));
    if(bannedSnap.exists()){
      const bannedObj = bannedSnap.val();
      if(Object.values(bannedObj).some(b => b.email === email)){
        return showError("This email is banned.");
      }
    }
    await set(codeRef,{...snap.val(), used:true});
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    const nick = prompt("Choose a nickname:") || "Anonymous";
    await set(ref(db,"users/"+cred.user.uid), { nickname: nick, email: email });
    showError("");
  }catch(err){
    showError(err.message);
  }
};

onAuthStateChanged(auth, async user => {
  if(user){
    const userRef = ref(db,"users/"+user.uid);
    const snap = await get(userRef);
    if(snap.exists() && snap.val().banned){
      await signOut(auth);
      return alert("You are banned.");
    }
    authContainer.style.display = "none";
    chatContainer.style.display = "block";
    if(snap.exists()){
      currentNickname = snap.val().nickname || "Anonymous";
      if(ADMIN_EMAILS.includes(user.email)){
        adminPanel.style.display = "block";
      } else {
        adminPanel.style.display = "none";
      }
    } else {
      adminPanel.style.display = "none";
    }
    loadMessages();
  } else {
    authContainer.style.display = "block";
    chatContainer.style.display = "none";
    clearMessages();
  }
});

/* Message send */
async function sendMessage(text="", imageUrl=""){
  if(!text && !imageUrl) return;
  const user = auth.currentUser;
  if(!user) return alert("You must be signed in.");
  const userSnap = await get(ref(db,"users/"+user.uid));
  if(userSnap.exists()){
    const u = userSnap.val();
    if(u.kicked) return alert("You‚Äôve been kicked. Please rejoin later.");
    if(u.banned) return alert("You are banned.");
    if(u.muted) return alert("You are muted and cannot send messages.");
  }
  await push(ref(db,"messages"), {
    uid: user.uid,
    email: user.email,
    nickname: currentNickname,
    text: text,
    imageUrl: imageUrl || "",
    timestamp: Date.now()
  });
  msgInput.value = "";
}

sendBtn.onclick = ()=> sendMessage(msgInput.value);
msgInput.addEventListener("keypress", e => { if(e.key === "Enter") sendMessage(msgInput.value); });

/* File upload to Cloudinary */
fileInput.addEventListener("change", async () => {
  const file = fileInput.files[0];
  if(!file) return;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "z1d4s4al"); 
  try{
    const res = await fetch("https://api.cloudinary.com/v1_1/dcbo4oozo/upload", { method:"POST", body:formData });
    const data = await res.json();
    if(data.secure_url){
      await sendMessage("", data.secure_url);
    }
    fileInput.value = "";
  }catch(err){
    alert("Upload failed: " + err.message);
  }
});

/* Load messages */
function loadMessages(){
  if(messagesRef) off(messagesRef);
  chatBox.innerHTML = "";
  messagesRef = query(ref(db,"messages"), orderByChild("timestamp"));

  onChildAdded(messagesRef, async snap => {
    const msg = snap.val();
    const wrapper = document.createElement("div");
    wrapper.className = "message";
    wrapper.id = "msg-" + snap.key;

    const d = new Date(msg.timestamp || Date.now());
    const hours = d.getHours();
    const minutes = d.getMinutes().toString().padStart(2,"0");
    const ampm = hours >= 12 ? "PM" : "AM";
    const displayHour = ((hours + 11) % 12) + 1;
    const timeStr = `${displayHour}:${minutes} ${ampm}`;

    const SUFFIXES = {
      "aj.xanman@gmail.com": " üëë",
      "alexa_pears736@ahschools.us": " üëë",
      "uyiog_aghay195@ahschools.us": " üêâ",
      "carso_keller363@ahschools.us": " ‚ö°",
      "legyo_dereg506@ahschools.us": " ‚ö°",
      "jacks_waara234@ahschools.us": " ‚ö°",
      "unclesam@gmail.com": " ‚ö°",
      "o71613869@gmail.com": " üêâ"
    };
    const suffix = SUFFIXES[msg.email] || "";

    // Plain white names only
    const nameHtml = `<strong style="color:#fff">${msg.nickname || "Anonymous"}${suffix}</strong>`;

    let content = `<div>${nameHtml} <span class="muted">(${timeStr}):</span></div>`;
    if(msg.text) content += `<div style="margin-top:4px;">${escapeHtml(msg.text)}</div>`;
    if(msg.imageUrl){
      const isVideo = /(\.mp4|\.webm|video\/)/i.test(msg.imageUrl) || msg.imageUrl.includes("video");
      if(isVideo){
        content += `<div><video class="chat-video" src="${msg.imageUrl}" controls></video></div>`;
      } else {
        content += `<div><img class="chat-img" src="${msg.imageUrl}" alt="image"/></div>`;
      }
    }

    wrapper.innerHTML = content;

    const currentUser = auth.currentUser;
    if(currentUser){
      const targetIsAdmin = ADMIN_EMAILS.includes(msg.email);
      const currentIsAdmin = ADMIN_EMAILS.includes(currentUser.email);
      if(msg.uid === currentUser.uid || (currentIsAdmin && !targetIsAdmin)){
        const del = document.createElement("span");
        del.className = "delete-btn";
        del.textContent = "[delete]";
        del.onclick = () => { if(confirm("Delete this message?")) remove(ref(db,"messages/"+snap.key)); };
        wrapper.appendChild(del);
      }
    }

    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;

    const img = wrapper.querySelector(".chat-img");
    const vid = wrapper.querySelector("video.chat-video");
    if(img) img.onclick = () => { modalVideo.style.display="none"; modalImg.style.display="block"; modalImg.src=img.src; imgModal.style.display="flex"; imgModal.setAttribute("aria-hidden","false"); };
    if(vid) vid.onclick = () => { modalImg.style.display="none"; modalVideo.style.display="block"; modalVideo.src=vid.src; imgModal.style.display="flex"; imgModal.setAttribute("aria-hidden","false"); };
  });

  onChildRemoved(ref(db,"messages"), snap => { const el = document.getElementById("msg-" + snap.key); if(el) el.remove(); });
}

function escapeHtml(text){ if(!text) return ""; return text.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'", "&#039;"); }

imgModal.onclick = (e) => { if(e.target === modalVideo) return; imgModal.style.display="none"; modalImg.src=""; modalVideo.src=""; modalImg.style.display="block"; modalVideo.style.display="none"; imgModal.setAttribute("aria-hidden","true"); };

logoutBtn.onclick = async () => { await signOut(auth); chatContainer.style.display="none"; authContainer.style.display="block"; clearMessages(); };

</script>
</body>
</html>
